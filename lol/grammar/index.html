<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Minna no Nihongo - Grammar</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --primary-dark: #1a237e;
      --accent-blue: #0288d1;
      --bg-light: #f8f9fa;
      --sidebar-width: 260px;
    }
    body {
      background-color: var(--bg-light);
      font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      color: #2c3e50;
      padding-top: 160px;
    }
    .navbar {
      background: var(--primary-dark) !important;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .lesson-sticky-header {
      position: fixed;
      top: 56px;
      width: 100%;
      z-index: 1020;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(5px);
      border-bottom: 2px solid #e0e0e0;
      padding: 10px 0;
    }
    .lesson-btn {
      border-radius: 20px;
      padding: 5px 15px;
      font-size: 0.9rem;
      font-weight: 600;
      white-space: nowrap;
    }
    .lesson-card {
      border: none;
      border-radius: 16px;
      box-shadow: 0 4px 25px rgba(0,0,0,0.05);
      margin-bottom: 4rem;
      background: white;
    }
    .lesson-header {
      background: linear-gradient(135deg, var(--primary-dark), var(--accent-blue));
      color: white;
      padding: 2rem;
      border-radius: 16px 16px 0 0;
    }
    /* Right Sidebar */
    #form-sidebar {
      position: fixed;
      top: 140px;
      right: 20px;
      width: var(--sidebar-width);
      max-height: 70vh;
      overflow-y: auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      padding: 15px;
      z-index: 1010;
      border: 1px solid #dee2e6;
      display: none;
    }
    #form-sidebar h6 {
      margin-bottom: 12px;
      font-size: 1rem;
      color: #333;
      border-bottom: 1px solid #eee;
      padding-bottom: 8px;
    }
    .form-link {
      display: block;
      padding: 8px 12px;
      margin: 4px 0;
      border-radius: 8px;
      font-size: 0.92rem;
      color: #0d47a1;
      text-decoration: none;
      transition: all 0.2s;
    }
    .form-link:hover {
      background: #e3f2fd;
      color: #01579b;
      font-weight: 500;
    }
    .jp-text {
      font-size: 1.75rem;
      font-weight: 600;
      color: #1a1a1a;
      line-height: 1.6;
      font-family: "Hiragino Mincho ProN", "MS PMincho", serif;
    }
    .romaji {
      font-size: 0.95rem;
      color: #6c757d;
    }
    .example-box {
      border-left: 4px solid var(--accent-blue);
      background: #fdfdfd;
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 8px;
    }
    @media (max-width: 992px) {
      #form-sidebar {
        display: none !important;
      }
    }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark fixed-top">
  <div class="container px-4">
    <a class="navbar-brand fw-bold" href="#">Minna no Nihongo</a>
    <div class="ms-auto d-none d-md-block">
      <span class="badge bg-light text-dark">Grammar Lessons</span>
    </div>
  </div>
</nav>

<div class="lesson-sticky-header">
  <div class="container">
    <div class="d-flex overflow-auto gap-2 pb-2" id="lesson-buttons"></div>
  </div>
</div>

<div class="container">
  <div id="lessons-container"></div>

  <!-- Right Sidebar: Forms jump to examples -->
  <div id="form-sidebar">
    <h6>Forms & Examples</h6>
    <div id="form-links"></div>
  </div>

  <div id="loading" class="text-center py-5">
    <div class="spinner-grow text-primary" role="status"></div>
    <p class="mt-3 text-muted fw-bold">Loading lessons from API...</p>
  </div>

  <div id="error" class="alert alert-danger d-none m-5 text-center"></div>
</div>

<script>
const API_URL = 'https://www.singhyogendra.com.np/lol/grammar/data.json';

async function loadLessons() {
  try {
    const response = await fetch(API_URL);
    if (!response.ok) throw new Error('Network response was not ok');

    let lessons = await response.json();
    lessons.sort((a, b) => a.lesson - b.lesson);

    document.getElementById('loading').remove();
    renderContent(lessons);
  } catch (err) {
    document.getElementById('loading').classList.add('d-none');
    document.getElementById('error').classList.remove('d-none');
    document.getElementById('error').textContent = `Error: ${err.message}`;
  }
}

function renderContent(lessons) {
  const container = document.getElementById('lessons-container');
  const btnContainer = document.getElementById('lesson-buttons');

  lessons.forEach(lesson => {
    // Lesson buttons
    const btn = document.createElement('button');
    btn.className = 'btn btn-outline-secondary btn-sm lesson-btn';
    btn.textContent = `L${lesson.lesson}`;
    btn.onclick = () => {
      const target = document.getElementById(`lesson-${lesson.lesson}`);
      if (target) {
        const headerOffset = 150;
        const elementPosition = target.getBoundingClientRect().top + window.scrollY;
        window.scrollTo({ top: elementPosition - headerOffset, behavior: 'auto' });
        updateFormSidebar(lesson); // Refresh sidebar when lesson changes
      }
    };
    btnContainer.appendChild(btn);

    // Lesson card
    const card = document.createElement('div');
    card.className = 'card lesson-card';
    card.id = `lesson-${lesson.lesson}`;

    let structureHtml = '';
    if (lesson.connection_structure) {
      structureHtml = '<div class="mb-4 bg-light p-3 rounded-3 border-start border-4 border-warning">';
      structureHtml += '<h6 class="text-uppercase text-muted small fw-bold mb-3">Connection Rules</h6>';
      Object.entries(lesson.connection_structure).forEach(([key, section]) => {
        const formName = section.form || key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        structureHtml += `
          <div class="structure-tag form-section" data-form="${formName}" id="form-${formName.replace(/\s+/g, '-')}">
            ${formName}
          </div>`;
        if (section.rules) {
          structureHtml += '<div class="row row-cols-1 row-cols-md-2 g-2 mb-3">';
          section.rules.forEach(rule => {
            structureHtml += `
              <div class="col small">
                <div class="p-2 border rounded bg-white">
                  <strong>${rule.base}</strong> <span class="text-danger">â†’</span>
                  ${rule.example || ''} <span class="text-primary fw-bold">${rule.plus_ndesu || rule.potential || rule.form_result || ''}</span>
                </div>
              </div>`;
          });
          structureHtml += '</div>';
        }
      });
      structureHtml += '</div>';
    }

    let grammarHtml = '';
    lesson.grammar_points?.forEach((point, idx) => {
      const pointId = `point-${idx + 1}`;
      grammarHtml += `
        <div class="grammar-point-wrapper mb-5" id="${pointId}">
          <h4 class="d-inline-block border-bottom border-primary border-3 pb-1 mb-3">${idx + 1}. ${point.point}</h4>
          <p class="lead text-secondary">${point.meaning || ''}</p>
          <div class="examples-list">
            ${point.examples?.map((ex, exIdx) => `
              <div class="example-box p-3 mb-3 shadow-sm rounded" id="ex-${idx + 1}-${exIdx + 1}">
                <div class="jp-text mb-1">${ex.jp}</div>
                <div class="romaji mb-2">${ex.romaji}</div>
                <div class="en-text text-dark fw-medium">${ex.en}</div>
              </div>
            `).join('') || ''}
          </div>
        </div>`;
    });

    card.innerHTML = `
      <div class="lesson-header">
        <h2 class="h1 mb-0">Lesson ${lesson.lesson}</h2>
        <div class="fs-4 opacity-75">${lesson.title}</div>
      </div>
      <div class="card-body p-4 p-md-5">
        ${structureHtml}
        ${grammarHtml}
      </div>
    `;
    container.appendChild(card);
  });
}

// Update sidebar with forms + jump to first relevant example/point
function updateFormSidebar(lesson) {
  const sidebar = document.getElementById('form-sidebar');
  const linksContainer = document.getElementById('form-links');
  linksContainer.innerHTML = '';

  if (lesson.connection_structure) {
    Object.entries(lesson.connection_structure).forEach(([key, section]) => {
      const formName = section.form || key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
      const link = document.createElement('a');
      link.className = 'form-link';
      link.href = '#';
      link.textContent = formName;
      link.onclick = (e) => {
        e.preventDefault();

        // Try to find the grammar point that mentions this form
        const pointElements = document.querySelectorAll('.grammar-point-wrapper h4');
        let target = document.querySelector(`[data-form="${formName}"]`); // fallback to form section

        for (let el of pointElements) {
          if (el.textContent.toLowerCase().includes(formName.toLowerCase())) {
            target = el.closest('.grammar-point-wrapper');
            break;
          }
        }

        if (target) {
          const offset = 180;
          const pos = target.getBoundingClientRect().top + window.scrollY;
          window.scrollTo({ top: pos - offset, behavior: 'auto' });
        }
      };
      linksContainer.appendChild(link);
    });
    sidebar.style.display = 'block';
  } else {
    sidebar.style.display = 'none';
  }
}

document.addEventListener('DOMContentLoaded', loadLessons);
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Minna no Nihongo - Grammar</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <style>
    :root {
      --primary-dark: #1a237e;
      --accent-blue: #0288d1;
      --bg-light: #f8f9fa;
    }

    body {
      background-color: var(--bg-light);
      font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      color: #2c3e50;
      padding-top: 160px;
    }

    /* Navbar & Navigation */
    .navbar {
      background: var(--primary-dark) !important;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    .lesson-sticky-header {
      position: fixed;
      top: 56px;
      width: 100%;
      z-index: 1020;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(5px);
      border-bottom: 2px solid #e0e0e0;
      padding: 10px 0;
    }

    .lesson-btn {
      border-radius: 20px;
      padding: 5px 15px;
      font-size: 0.9rem;
      font-weight: 600;
      white-space: nowrap;
    }

    /* Lesson Cards */
    .lesson-card {
      border: none;
      border-radius: 16px;
      box-shadow: 0 4px 25px rgba(0,0,0,0.05);
      margin-bottom: 4rem;
      background: white;
    }

    .lesson-header {
      background: linear-gradient(135deg, var(--primary-dark), var(--accent-blue));
      color: white;
      padding: 2rem;
      border-radius: 16px 16px 0 0;
    }

    /* Japanese Text Styling */
    .jp-text {
      font-size: 1.75rem;
      font-weight: 600;
      color: #1a1a1a;
      line-height: 1.6;
      font-family: "Hiragino Mincho ProN", "MS PMincho", serif;
    }

    ruby {
      ruby-align: center;
    }

    rt {
      font-size: 0.45em;
      color: var(--accent-blue);
      font-weight: normal;
    }

    .romaji {
      font-size: 0.95rem;
      color: #6c757d;
      letter-spacing: 0.5px;
    }

    /* Grammar Structure Boxes */
    .structure-tag {
      display: inline-block;
      padding: 4px 12px;
      background: #e3f2fd;
      color: #0d47a1;
      border-radius: 6px;
      font-weight: bold;
      font-size: 0.9rem;
      margin-bottom: 10px;
    }

    .example-box {
      border-left: 4px solid var(--accent-blue);
      background: #fdfdfd;
      transition: all 0.3s ease;
    }

    .example-box:hover {
      background: #f0f7ff;
    }

    #backToTop {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: none;
      z-index: 1000;
    }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark fixed-top">
  <div class="container px-4">
    <a class="navbar-brand fw-bold" href="#"> Minna no Nihongo  </a>
    <div class="ms-auto d-none d-md-block">
      <span class="badge bg-light text-dark">All Grammar </span>
    </div>
  </div>
</nav>

<div class="lesson-sticky-header">
  <div class="container">
    <div class="d-flex overflow-auto gap-2 pb-2" id="lesson-buttons">
      </div>
  </div>
</div>

<div class="container">
  <div id="lessons-container"></div>

  <div id="loading" class="text-center py-5">
    <div class="spinner-grow text-primary" role="status"></div>
    <p class="mt-3 text-muted fw-bold">Generating Lesson Material...</p>
  </div>

  <div id="error" class="alert alert-danger d-none m-5 text-center"></div>
</div>

<button id="backToTop" class="btn btn-primary rounded-circle shadow">↑</button>

<script>
const API_URL = 'https://www.singhyogendra.com.np/lol/grammar/data.json';

// Helper to handle furigana if the API provides it in format: [Kanji](furigana)
// Or just cleans text.
function formatJp(text) {
  if(!text) return '';
  return text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<ruby>$1<rt>$2</rt></ruby>');
}

async function loadLessons() {
  try {
    const response = await fetch(API_URL);
    if (!response.ok) throw new Error('Network response was not ok');
    const lessons = await response.json();
    
    document.getElementById('loading').remove();
    renderContent(lessons);
  } catch (err) {
    document.getElementById('loading').classList.add('d-none');
    const errDiv = document.getElementById('error');
    errDiv.classList.remove('d-none');
    errDiv.innerHTML = `<h5>Load Error</h5><p>${err.message}</p>`;
  }
}

function renderContent(lessons) {
  const container = document.getElementById('lessons-container');
  const btnContainer = document.getElementById('lesson-buttons');

  lessons.forEach(lesson => {
    // 1. Create Nav Buttons
    const btn = document.createElement('button');
    btn.className = 'btn btn-outline-secondary btn-sm lesson-btn';
    btn.innerText = `L${lesson.lesson}`;
    btn.onclick = () => window.scrollTo({ 
        top: document.getElementById(`lesson-${lesson.lesson}`).offsetTop - 150, 
        behavior: 'smooth' 
    });
    btnContainer.appendChild(btn);

    // 2. Create Card
    const card = document.createElement('div');
    card.className = 'card lesson-card';
    card.id = `lesson-${lesson.lesson}`;

    let structureHtml = '';
    if (lesson.connection_structure) {
      structureHtml = '<div class="mb-4 bg-light p-3 rounded-3 border-start border-4 border-warning">';
      structureHtml += '<h6 class="text-uppercase text-muted small fw-bold mb-3">Connection Rules</h6>';
      Object.entries(lesson.connection_structure).forEach(([key, section]) => {
        structureHtml += `<div class="structure-tag">${section.form || key}</div>`;
        if (section.rules) {
          structureHtml += '<div class="row row-cols-1 row-cols-md-2 g-2 mb-3">';
          section.rules.forEach(rule => {
            structureHtml += `
              <div class="col small">
                <div class="p-2 border rounded bg-white">
                  <strong>${rule.base}</strong> <span class="text-danger">→</span> ${rule.example || ''} 
                  <span class="text-primary fw-bold">${rule.plus_ndesu || rule.potential || rule.form_result || ''}</span>
                </div>
              </div>`;
          });
          structureHtml += '</div>';
        }
      });
      structureHtml += '</div>';
    }

    let grammarHtml = '';
    lesson.grammar_points?.forEach((point, idx) => {
      grammarHtml += `
        <div class="grammar-point-wrapper mb-5">
          <h4 class="d-inline-block border-bottom border-primary border-3 pb-1 mb-3">${idx + 1}. ${point.point}</h4>
          <p class="lead text-secondary">${point.meaning || ''}</p>
          <div class="examples-list">
            ${point.examples?.map(ex => `
              <div class="example-box p-3 mb-3 shadow-sm rounded">
                <div class="jp-text mb-1">${formatJp(ex.jp)}</div>
                <div class="romaji mb-2">${ex.romaji}</div>
                <div class="en-text text-dark fw-medium">${ex.en}</div>
              </div>
            `).join('') || ''}
          </div>
        </div>`;
    });

    card.innerHTML = `
      <div class="lesson-header">
        <h2 class="h1 mb-0">Lesson ${lesson.lesson}</h2>
        <div class="fs-4 opacity-75">${lesson.title}</div>
      </div>
      <div class="card-body p-4 p-md-5">
        ${structureHtml}
        ${grammarHtml}
      </div>
    `;
    container.appendChild(card);
  });
}

// Scroll logic for Back to Top
const btt = document.getElementById('backToTop');
window.onscroll = () => {
  btt.style.display = (window.scrollY > 500) ? 'block' : 'none';
};
btt.onclick = () => window.scrollTo({ top: 0, behavior: 'smooth' });

document.addEventListener('DOMContentLoaded', loadLessons);
</script>

</body>
</html>

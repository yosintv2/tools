name: Update News API
on:
  schedule:
    - cron: '0 * * * *' 
  workflow_dispatch: 

jobs:
  update-news:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Fetch and Merge News
        run: |
          curl "https://english.onlinekhabar.com/wp-json/wp/v2/posts?per_page=20&_embed" -o latest_news.json
          
          python3 - <<EOF
          import json
          import os

          # Updated path to include 'data/' folder
          file_path = 'data/news.json'
          
          if os.path.exists(file_path):
              with open(file_path, 'r') as f:
                  try:
                      old_news = json.load(f)
                  except:
                      old_news = []
          else:
              old_news = []

          with open('latest_news.json', 'r') as f:
              new_news = json.load(f)

          existing_ids = {item['id'] for item in old_news}
          unique_new_news = [item for item in new_news if item['id'] not in existing_ids]

          # New news at the top, followed by old news
          final_news = unique_new_news + old_news
          
          # Keep last 200 items
          final_news = final_news[:200]

          # Ensure the directory exists (just in case)
          os.makedirs('data', exist_ok=True)

          with open(file_path, 'w') as f:
              json.dump(final_news, f, indent=2)
          EOF

      - name: Commit and Push Changes
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git add data/news.json
          git commit -m "Update data/news.json with latest posts" || exit 0
          git push

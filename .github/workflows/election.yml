name: Nepal Election 2082 - CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      deploy:
        description: 'Deploy after tests?'
        required: false
        type: boolean
        default: true

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: [3.8, 3.9, '3.10']
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov flake8
    
    - name: Lint with flake8
      run: |
        # stop the build if there are Python syntax errors or undefined names
        flake8 election.py --count --select=E9,F63,F7,F82 --show-source --statistics
        # exit-zero treats all errors as warnings
        flake8 election.py --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    
    - name: Test with pytest
      run: |
        pytest --cov=. --cov-report=xml || true
      continue-on-error: true
    
    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: |
      (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy == 'true')
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Display Manual Trigger Info
      if: github.event_name == 'workflow_dispatch'
      run: |
        echo "üöÄ Manual Deployment Triggered!"
        echo "Environment: ${{ github.event.inputs.environment }}"
        echo "Deploy: ${{ github.event.inputs.deploy }}"
    
    - name: Check Heroku Secrets
      run: |
        if [ -z "${{ secrets.HEROKU_API_KEY }}" ]; then
          echo "‚ö†Ô∏è HEROKU_API_KEY not configured"
          echo "To enable Heroku deployment:"
          echo "1. Go to GitHub Settings ‚Üí Secrets and variables ‚Üí Actions"
          echo "2. Add HEROKU_API_KEY from https://dashboard.heroku.com/account"
          echo "3. Add HEROKU_APP_NAME with your app name"
        else
          echo "‚úÖ Heroku secrets configured"
        fi
    
    - name: Deploy to Heroku
      if: secrets.HEROKU_API_KEY != ''
      uses: akhileshns/heroku-deploy@v3.12.12
      with:
        heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
        heroku_app_name: ${{ secrets.HEROKU_APP_NAME }}
        heroku_email: ${{ secrets.HEROKU_EMAIL }}
        usedocker: false
      continue-on-error: true
    
    - name: Deployment Complete
      run: |
        if [ -z "${{ secrets.HEROKU_API_KEY }}" ]; then
          echo "‚ö†Ô∏è Skipped Heroku deployment - secrets not configured"
          echo "App is ready to deploy. Configure Heroku secrets when ready."
        else
          echo "‚úÖ Deployment attempted. Check Heroku dashboard for status."
        fi

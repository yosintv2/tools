name: Update Sports Feed
on:
  schedule:
    - cron: '0 * * * *' # Updates every hour
  workflow_dispatch: 

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch and Convert RSS
        run: |
          mkdir -p data
          # Fetch the RSS feed
          curl -sL "https://english.onlinekhabar.com/category/sports/feed" -o sports_feed.xml
          
          python3 - <<EOF
          import xml.etree.ElementTree as ET
          import json
          import os
          import re

          def clean_text(text):
              if not text: return ""
              return re.sub('<[^<]+?>', '', text).strip()

          try:
              tree = ET.parse('sports_feed.xml')
              root = tree.getroot()
              items = root.findall('./channel/item')
              
              namespaces = {'media': 'http://search.yahoo.com/mrss/'}
              new_data = []

              for item in items:
                  title = item.find('title').text
                  link = item.find('link').text
                  pub_date = item.find('pubDate').text
                  description = item.find('description').text if item.find('description') is not None else ""
                  
                  # Find image in media tag or fallback to a placeholder
                  image = "https://via.placeholder.com/1080x1920?text=Sports"
                  media_content = item.find('media:content', namespaces)
                  if media_content is not None:
                      image = media_content.get('url')

                  new_data.append({
                      "id": link,
                      "date": pub_date,
                      "title": {"rendered": title},
                      "excerpt": {"rendered": clean_text(description)[:150] + "..."},
                      "content": {"rendered": description},
                      "featured_image": image
                  })

              # Load existing sports.json
              file_path = 'data/sports.json'
              if os.path.exists(file_path):
                  with open(file_path, 'r') as f:
                      try:
                          old_data = json.load(f)
                      except:
                          old_data = []
              else:
                  old_data = []

              # Prevent duplicates and prepend new news
              existing_ids = {post['id'] for post in old_data}
              unique_new = [p for p in new_data if p['id'] not in existing_ids]
              
              final_json = unique_new + old_data
              
              with open(file_path, 'w') as f:
                  json.dump(final_json[:200], f, indent=2)
                  
          except Exception as e:
              print(f"Error: {e}")
          EOF

      - name: Commit Changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add data/sports.json
          git commit -m "Update sports.json" || exit 0
          git push
